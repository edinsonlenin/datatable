<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <LINK href="../Utilitarios/seriva-stiles.css" type="text/css" rel="stylesheet">
    <SCRIPT src="../Utilitarios/JScript/jsUtil.js" type="text/javascript"></SCRIPT>
    <link href="../Utilitarios/cliente.css" type="text/css" rel="stylesheet" />
    <link href="../src/css/custom.datatable.css" rel="stylesheet" />

    <script type="text/javascript" src="../Scripts/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="../src/assets/handlebars/js/handlebars.min.js"></script>
    <script type="text/javascript" src="../src/assets/dataTable/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="../src/assets/dataTable/resize.datatable.js"></script>
    <script type="text/javascript" src="../src/assets/dataTable/dataTables.select.min.js"></script>
    <script type="text/javascript" src="../src/js/CustomDataTable.js"></script>
    <script type="text/javascript" src="../src/js/styleUwg.js"></script>

    <!--referencias para exportación a excel -->
    <link href="../src/assets/dataTable/buttons.dataTables.min.css" rel="stylesheet" />
    <style type="text/css">
        table tbody tr td[colspan="8"] {
            padding-left: 33px !important;
            padding-top: 0rem !important;
            padding-right: 0rem !important;
        }

        table tr td[colspan="7"] {
            padding-left: 2.1rem !important;
            padding-top: 0rem !important;
            padding-right: 0rem !important;
        }

        table.dataTable {
            margin: 0 !important;
        }
    </style>

    <script type="text/javascript" src="../src/assets/dataTable/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="../src/assets/dataTable/jszip.min.js"></script>
    <script type="text/javascript" src="../src/assets/dataTable/buttons.html5.min.js"></script>

    <link href="../src/assets/Bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <script src="script.js"></script>
    <script>
        let parentRowsIndex = [0];
        let secondRowsIndex = [0];
        let tablaColumnasExportar;
        let tablaData = personas;
        function buttons(tabla, filtro){
            return [
                    {
                        extend: 'excelHtml5',
                        title: '',
                        exportOptions: {
                            columns: tablaColumnasExportar
                        },
                        customizeData: function (data) {
                            let tcd = eval(`${tabla}ColumnasDetalle`);
                            let datos = eval(`${tabla}Data`);
                            let subchild = [...data.body];
                            let secondTable = ['', ...tcd.map(x => x.title)];
                            let columnas = tcd.map(x => x.data)
                            let numberRow = 0;
                            subchild.forEach((e, i) => {
                                let filas = datos.find(x => eval(filtro)).Detalle;
                                ++numberRow;
                                parentRowsIndex.push(numberRow);
                                filas.forEach((el, idx) => {
                                    let detalle = [""];
                                    Object.entries(el).forEach(([key, value]) => {
                                        if (columnas.includes(key))
                                            detalle.push(value);
                                        console.log(detalle);
                                    })
                                    data.body.splice(numberRow, null, secondTable);
                                    ++numberRow;
                                    secondRowsIndex.push(numberRow);
                                    data.body.splice(numberRow, null, detalle)
                                    ++numberRow;
                                })
                            })
                        },
                        customize: function (xlsx) {
                            let tc = eval(`${tabla}Columnas`);
                            let tce = eval(`${tabla}ColumnasExportar`);
                            let tcd = eval(`${tabla}ColumnasDetalle`);
                            let style = xlsx.xl['styles.xml'];
                            let s = '1';
                            $("styleSheet", style).replaceWith(styleUwg);

                            let sheet = xlsx.xl.worksheets['sheet1.xml'];
                            let sheetPr = `<sheetPr><outlinePr summaryBelow="0"/></sheetPr>`;
                            let indice = 1;
                            $("worksheet", sheet).prepend(sheetPr);
                            $("sheetFormatPr", sheet).attr("outlineLevelRow", "1");

                            $('row', sheet).each(function (i, element) {
                                if (!parentRowsIndex.includes(i)) {
									$(element).attr('outlineLevel', '1');
									$(element).attr('hidden', '1');
								}
                                s = '1';
                                if (!secondRowsIndex.includes(i)) {
									if (parentRowsIndex.includes(i))
										$(element).find('c').each(function (j) {
                                        let position = tce[j];
											$(this).removeAttr('s');
											if (tc[position].class == 'text-center')
												$(this).attr('s', 4);
											else if (tc[position].class == 'text-start')
												$(this).attr('s', 5);
											else if (tc[position].class == 'text-end')
												$(this).attr('s', 6);
											else
												$(this).attr('s', 5);
										})
									else
										$(element).find('c').each(function (j) {
											$(this).removeAttr('s');
											if (tcd[j].class == 'text-center')
												$(this).attr('s', 4);
											else if (tcd[j].class == 'text-start')
												$(this).attr('s', 5);
											else if (tcd[j].class == 'text-end')
												$(this).attr('s', 6);
											else
												$(this).attr('s', 6);
										})
								}
                                else {
                                    
                                    if (align_header === 'center')
                                        s = '1'
                                    else if (align_header === 'start')
                                        s = '2'
                                    else if (align_header === 'end')
                                        s = '3'

                                    $(element).find('c').each(function (k) {
                                            $(this).attr('s', s);
                                    })
                                }

                            })
                        }
                    }
                ];
        }
        $(document).ready(function () {
            /*let key1 = "nombre";
            let key2 = "apellido";
            let indice1 = 0;
            let indice2 = 1;                            
            let filtro = `x[key1].trim() == e[indice1].trim() &&
                            x[key2].trim() == e[indice2].trim()`;*/
            let filtro = `x['id'].trim() == e[0].trim()`;
            let tablaColumnas = [
                { class: 'amarillo dt-control', width: '33px', export:false },
                { data: "id", title: 'Id', class: "text-center", visible:false, export:true },
                { data: "nombre", title: 'Nombre', class: "text-start" },
                { data: "apellido", title: 'Apellido', class: "text-start" },
                { data: "edad", title: 'Edad', class: "text-end" },
                { data: "sexo", title: 'Sexo', class: "text-center", visible:false, export:true },
                { data: "sueldo", title: 'Sueldo', class: "text-end" },
                { data: "hobbies", title: 'Hobbbies', class: "text-start" },
            ];

            let tablaColumnasDetalle = [
                { data: "actividad", title: 'Actividad', class: "text-start" },
                { data: "duracion", title: 'Duracion', class: "text-end" },
                { data: "esfuerzo", title: 'Esfuerzo', class: "text-center" },
            ];

            let tablaColumnasExportar = tablaColumnas.map((x, y) => { return { y, x } }).filter((x, y) => ((x.x.visible == undefined || x.x.visible || x.x.export)&&(x.x.export == undefined || x.x.export))).map(x => x.y);
            let align_header = 'start';

            let tabletablaColumnas = new BaseDataTable('#tabletablaColumnas', {
                data: tablaData,
                columns: tablaColumnas,
                select: {
                    style: 'os',
                    selector: 'td:not(.dt-control)',
                    toggleable: false
                },
                columnDefs: [{
                    "defaultContent": "",
                    "targets": "_all"
                }],
                rowId: 'id',
                renderRowExpanded: async (rowData) => {
                    let source = document.getElementById("nested-table-template-01").innerHTML;
                    let template = Handlebars.compile(source);
                    let html = template(rowData);
                    return html;
                },
                onRowExpand: async ($row) => {
                    let options = {
                        columns: tablaColumnasDetalle,
                        rowId: "id",
                        parentTable: tabletablaColumnas
                    };
                    let tableHtml = $($row.child()).find("table");
                    let nestedDataTable = new BaseDataTable(tableHtml, options);
                    nestedDataTable.init();
                    return nestedDataTable;
                },
                dom: 'B',
                buttons: buttons(tabla, filtro)
            })
            tabletablaColumnas.init();


        });
    </script>
</head>

<body>
    <form>
        <div class="container-fluid">
            <table>
                <tr>
                    <td>
                        algun texto
                    </td>
                </tr>
            </table>
            <div class="container-fluid">

                <table id="tabletablaColumnas" class="cell-border tabla-general stripe  dataTable no-footer" width="80%"
                    height="60%"></table>
            </div>
        </div>
    </form>

    <script id="nested-table-template-01" type="text/x-handlebars-template">
        <table class="cell-border tabla-general stripe hijos" width="50%" id='row_expanded_{{id}}'>
            <thead>
                <tr>
                    <th width="50%"></th>
                    <th width="20%"></th>
                    <th width="30%"></th>
                </tr>
            </thead>
            <tbody>
                {{# each Detalle}}
                    <tr id="{{idDetalle}}" data-parentid="{{id}}">
                        <td>{{actividad}}</td>
                        <td>{{duracion}}</td>
                        <td>{{esfuerzo}}</td>
                    </tr>
                {{/each}}
            </tbody>
        </table>
    </script>
</body>

</html>